<!doctype html><html><head><title>nRF52开发笔记 :: 闲一文档</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=revised content="2020-12-15T09:59:15 UTC"><meta name=description content><title>nRF52开发笔记 :: 闲一文档</title><link rel="shortcut icon" href=/wedoc/images/favicon.png type=image/x-icon><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css integrity=sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.css><script src=https://code.jquery.com/jquery-3.5.1.min.js></script><link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel=stylesheet><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/layout.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/css/style.main.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/css/style.menu.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/notice.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/tabs.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/panel.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/columns.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/children.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/attachments.css><link rel=stylesheet type=text/css href=https://xianii.gitee.io/wedoc/sass/shortcodes/alert.css><link rel=stylesheet type=text/css href=/wedoc/css/docport.css><script src=/wedoc/js/docport.js></script><script type=text/javascript>var baseurl="https:\/\/xianii.gitee.io\/wedoc\/";</script><script>MathJax={tex:{inlineMath:[['$','$']],displayMath:[["$$","$$"]]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.bootcdn.net/ajax/libs/mathjax/3.0.5/es5/tex-svg.js></script></head><body data-url=/wedoc/notes/nrf52note/><style type=text/css>#debug{display:-webkit-box;display:-ms-flexbox;display:flex;line-height:3.5rem;margin-bottom:.35rem;padding:0 2rem;position:fixed;left:0;right:0;top:0;top:0;min-height:150px;background-color:#fff;border:3px solid red;z-index:10000;word-wrap:all;overflow:auto}</style><header><div><div class=burger><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')">&#9776;</a></div><div><a class=baselink href=https://xianii.gitee.io/wedoc/>闲一文档</a></div></div></header><article><aside><div class=search><div class=searchbox><input data-search-input id=search-by type=text placeholder="Type to search..."></div><script type=text/javascript src=/wedoc/vendor/lunr/lunr.min.js></script><script type=text/javascript src=/wedoc/vendor/auto-complete/auto-complete.js></script><link href=/wedoc/vendor/auto-complete/auto-complete.css rel=stylesheet><script type=text/javascript>var baseurl="https:\/\/xianii.gitee.io\/wedoc\/";</script><script type=text/javascript src=/wedoc/js/search.js></script></div><div id=close_menu><a href=javascript:void(0); style=font-size:15px onclick="$('article > aside').toggleClass('responsive')"><i class="fa fa-lg fa-times"></i></a></div><ul class=menu><li data-nav-id=https://xianii.gitee.io/wedoc/docs/ class="dd-item haschildren
item_level_$level"><i class="fas fa-chevron-right ddexp"></i><a href=/wedoc/docs/>开发环境</a><ul><li data-nav-id=https://xianii.gitee.io/wedoc/docs/tools/ class="dd-item
item_level_$level"><a href=/wedoc/docs/tools/>工具链安装</a></li></ul></li><li data-nav-id=https://xianii.gitee.io/wedoc/notes/ class="dd-item parent active
item_level_$level"><a href=/wedoc/notes/>指导笔记</a></li><li data-nav-id=https://xianii.gitee.io/wedoc/usage/ class="dd-item
item_level_$level"><a href=/wedoc/usage/>模板用例</a></li></ul></aside><section class=page><nav id=ariane aria-label=breadcrumb><ol class=ariane><li><a class=text-link href=https://xianii.gitee.io/wedoc/>Home</a></li><li><a class=text-link href=/wedoc/notes/>指导笔记</a></li><li class=active>nRF52开发笔记</li></ol></nav><h1>指导笔记<span>nRF52开发笔记</span></h1><nav class=subpages><li class=active><a title=$pagetitle href=/wedoc/notes/nrf52note/>nRF52开发笔记</a></li><li><a title=$pagetitle href=/wedoc/notes/zephyrnote/>Zephyr笔记</a></li><li><a title=$pagetitle href=/wedoc/notes/memo/>备忘杂记</a></li></nav><div class=jump-to-section><span onclick="$h=$(this);$h.next('nav').slideToggle(100,function(){$h.children('i').attr('class',function(){return $h.next('nav').is(':visible')?'fas fa-chevron-down':'fas fa-chevron-right';});});"><span class="fas fa-align-right"></span>Jump to Section
<i class="fas fa-chevron-right"></i></span><nav id=TableOfContents><ul><li><a href=#nrf52从机发送缓冲区溢出报错>nRF52从机发送缓冲区溢出报错</a></li><li><a href=#nrf52-广播包拼接>nRF52 广播包拼接</a></li><li><a href=#nrf52-蓝牙更新广播信息>nRF52 蓝牙更新广播信息</a></li><li><a href=#nrf52连接间隔与通信带宽问题>nRF52连接间隔与通信带宽问题</a></li><li><a href=#蓝牙在有效距离内易断开>蓝牙在有效距离内易断开</a></li><li><a href=#nrf52接仿真器能运行接电源不能运行>nRF52接仿真器能运行接电源不能运行</a></li><li><a href=#nrf52-fds库在o2优化等级报错>nRF52 FDS库在o2优化等级报错</a></li><li><a href=#nrf52-使用p021作为io口>nRF52 使用P0.21作为IO口</a></li><li><a href=#nrf52-i2s驱动ws2812>nRF52 I2S驱动WS2812</a></li></ul></nav></div><div class=content><h2 ref=nrf52从机发送缓冲区溢出报错>nRF52从机发送缓冲区溢出报错</h2><a class=anchor id=nrf52从机发送缓冲区溢出报错></a><p>BLE从机发送缓冲区溢出会导致发送中断，并在下一次发送时发生断开。需要捕获和处理报错。</p><p>可以额外添加一级缓冲，并对超出缓冲区的部分做丢弃处理。</p><hr><h2 ref=nrf52-广播包拼接>nRF52 广播包拼接</h2><a class=anchor id=nrf52-广播包拼接></a><p>当<code>m_advertising.adv_data.adv_data.len</code>与其中<code>EIR</code>长度之和不等时，发生的解析错误可能将相邻广播包连接起来。</p><p>其机制还需进一步分析了解。</p><hr><h2 ref=nrf52-蓝牙更新广播信息>nRF52 蓝牙更新广播信息</h2><a class=anchor id=nrf52-蓝牙更新广播信息></a><p>使用<code>ble_advertising_advdata_update</code>更新广播信息时。</p><p>在广播开启时，更改内容实时生效，更改广播长度在下一次开启广播时生效</p><hr><h2 ref=nrf52连接间隔与通信带宽问题>nRF52连接间隔与通信带宽问题</h2><a class=anchor id=nrf52连接间隔与通信带宽问题></a><ul><li>在<code>CSW-V1</code>上，在<code>250ms</code>连接间隔下，使用<code>request</code>方式通信只能达到2Hz左右的频率。</li><li>在<code>CSW-V1</code>上，在<code>250ms</code>连接间隔下，使用<code>command</code>方式通信，延迟在1-2个连接间隔。</li><li>在<code>CSW-B5</code>上，在<code>250ms</code>连接间隔下，使用<code>command</code>方式通信，延迟在几十ms之内，且在80ms内即返回了24个数据包。同时，测试功耗没有异常。</li></ul><p>更改<code>gap_conn_cfg.event_length</code>至<code>16</code>可实现每个连接间隔可返回<code>20+</code>个数据包</p><p><code>gap_conn_cfg.event_length</code>默认值为<code>3</code>，其为一个以<code>1.25ms</code>为单位的窗口时间，每个连接间隔能够通信的时长由这个窗口的时间决定。</p><hr><h2 ref=蓝牙在有效距离内易断开>蓝牙在有效距离内易断开</h2><a class=anchor id=蓝牙在有效距离内易断开></a><p>断开原因为:0x08(<code>timeout</code>)</p><p>考虑调整晶振精度参数，降低精度要求：比如从<code>20ppm</code>改为<code>50ppm</code></p><p>参考资料：
<a href=https://devzone.nordicsemi.com/f/nordic-q-a/29786/ble_hci_connection_timeout-and-nrf_clock_lf_xtal_accuracy_xx_ppm/118161#118161>https://devzone.nordicsemi.com/f/nordic-q-a/29786/ble_hci_connection_timeout-and-nrf_clock_lf_xtal_accuracy_xx_ppm/118161#118161</a></p><hr><h2 ref=nrf52接仿真器能运行接电源不能运行>nRF52接仿真器能运行接电源不能运行</h2><a class=anchor id=nrf52接仿真器能运行接电源不能运行></a><p>可能原因有：</p><ol><li>软件使能了 DCDC，但硬件未有外部 DCDC 电路。关闭 DCDC 可修复。</li><li>printf 重定向问题。<code>Case ID: 207373</code></li></ol><hr><h2 ref=nrf52-fds库在o2优化等级报错>nRF52 FDS库在o2优化等级报错</h2><a class=anchor id=nrf52-fds库在o2优化等级报错></a><p>**问题：**在o2优化等级下，被写入的数据指针会有非 word 对齐的情况，此时会报错。</p><p>**解决：**对需要使用 fds 写入的数据均使用强制 word 对齐。在 SES 中可使用<code>__ALIGN(4)</code></p><hr><h2 ref=nrf52-使用p021作为io口>nRF52 使用P0.21作为IO口</h2><a class=anchor id=nrf52-使用p021作为io口></a><p><strong>编译时更改</strong></p><p>去掉<code>CONFIG_GPIO_AS_PINRESET</code>宏，重新完全编译。
使用<code>nrfjrog -eraseuicr</code>擦除 UICR 区域。因为使用 IDE 烧录是不会主动擦除 UICR 的，会导致 reset 引脚的配置没有改变。</p><p><strong>发行后更改</strong></p><p>使用如下函数可以禁用UICR中的reset引脚复位功能。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/** Function to disable pin reset by writing an invalid configuration (all 0) to PSELRESET[1] */</span>
<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>disable_pin_reset</span>(<span style=color:#66d9ef>void</span>)
{
    <span style=color:#75715e>// Only perform if needed (which is the first time this code runs)
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (NRF_UICR<span style=color:#f92672>-&gt;</span>PSELRESET[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
    {
        NRF_LOG_INFO(<span style=color:#e6db74>&#34;Disabling pin reset.&#34;</span>);

        NRF_NVMC<span style=color:#f92672>-&gt;</span>CONFIG <span style=color:#f92672>=</span> NVMC_CONFIG_WEN_Wen;
        <span style=color:#66d9ef>while</span> (NRF_NVMC<span style=color:#f92672>-&gt;</span>READY <span style=color:#f92672>==</span> NVMC_READY_READY_Busy){}

        NRF_UICR<span style=color:#f92672>-&gt;</span>PSELRESET[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;

        NRF_NVMC<span style=color:#f92672>-&gt;</span>CONFIG <span style=color:#f92672>=</span> NVMC_CONFIG_WEN_Ren;
        <span style=color:#66d9ef>while</span> (NRF_NVMC<span style=color:#f92672>-&gt;</span>READY <span style=color:#f92672>==</span> NVMC_READY_READY_Busy){}

        <span style=color:#75715e>// System reset is needed to update UICR registers.
</span><span style=color:#75715e></span>        NVIC_SystemReset();
    }
}
</code></pre></div><hr><h2 ref=nrf52-i2s驱动ws2812>nRF52 I2S驱动WS2812</h2><a class=anchor id=nrf52-i2s驱动ws2812></a><p>参考：
<a href=https://electronut.in/nrf52-i2s-ws2812>https://electronut.in/nrf52-i2s-ws2812</a></p><ul><li>当<code>sck</code>引脚功能被占据时，会导致除<code>lrck</code>引脚外的其他引脚输出异常。而<code>lrck</code>仍能正常输出时钟信号。</li><li>I2S 的驱动使用了双缓冲方式。在第二缓冲未设置时，会产生<code>NRFX_I2S_STATUS_NEXT_BUFFERS_NEEDED</code>事件回调。</li><li>实现单次输出 WS2812 驱动波形的方式如下：<ol><li>i2s start</li><li>第一次会在输出第一个时钟周期时产生<code>NEXT_BUFFER</code>事件，在这里设置第二缓冲</li><li>当第一缓冲输出至最后一个时钟周期时，驱动自动切换至第二缓冲，此时会产生第二次<code>NEXT_BUFFER</code>事件，以此作为波形输出结束的标志。在此时关闭i2s输出</li></ol></li><li>在波形最后添加一个<code>0x00000000</code>的填充，就可以避免有效数据被剪切掉。</li><li>I2S输出高4位与低4位需要交换才能与 WS2812 的数据一致。<ul><li>如：I2S 写入 <code>0x8888E888</code> 则 WS2812 收到 <code>0x80</code></li></ul></li></ul></div><div class=chevrons><a class=next href=/wedoc/usage/ title=模板用例 style=margin-right:0><div><p>Next page</p><label>模板用例</label></div><i class="fas fa-arrow-right" style=font-size:1.7em></i></a></div></section><section class=right-menu><div class=TableOfContents><label><i class="fas fa-align-right"></i>&nbsp;&nbsp;What's on this page</label><nav><ul><li><a href=/wedoc/notes/nrf52note/>nRF52开发笔记</a></li></ul></nav><nav id=TableOfContents><ul><li><a href=#nrf52从机发送缓冲区溢出报错>nRF52从机发送缓冲区溢出报错</a></li><li><a href=#nrf52-广播包拼接>nRF52 广播包拼接</a></li><li><a href=#nrf52-蓝牙更新广播信息>nRF52 蓝牙更新广播信息</a></li><li><a href=#nrf52连接间隔与通信带宽问题>nRF52连接间隔与通信带宽问题</a></li><li><a href=#蓝牙在有效距离内易断开>蓝牙在有效距离内易断开</a></li><li><a href=#nrf52接仿真器能运行接电源不能运行>nRF52接仿真器能运行接电源不能运行</a></li><li><a href=#nrf52-fds库在o2优化等级报错>nRF52 FDS库在o2优化等级报错</a></li><li><a href=#nrf52-使用p021作为io口>nRF52 使用P0.21作为IO口</a></li><li><a href=#nrf52-i2s驱动ws2812>nRF52 I2S驱动WS2812</a></li></ul></nav></div><div class=Actions><nav><ul></ul></nav></div></section></article><footer><p>&mldr;</p></footer></body></html>